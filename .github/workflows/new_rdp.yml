name: "ðŸ—ž New GeoRDP"

on:
  workflow_dispatch:
    inputs:
      date:
        type: string
        description: Date de la prochaine RDP au format YYYY-MM-DD
        required: true
      notify-slack:
        type: boolean
        description: Notifie l'Ã©quipe sur Slack

env:
  LANG: "fr_FR.UTF-8"
  LC_ALL: "fr_FR.UTF-8"
  LC_TIME: "fr_FR.UTF-8"

jobs:
  create_rdp:
    runs-on: ubuntu-latest

    steps:
      - name: Install French locale
        run: |
          sudo locale-gen fr_FR.UTF-8
          sudo update-locale LANG=fr_FR.UTF-8

      - name: Get source code
        uses: actions/checkout@v2

      - name: Create a new GeoRDP
        shell: bash
        run: |
          # make file runnable, might not be necessary
          # chmod +x ./tools/new_rdp.sh

          # run script
          bash ./tools/new_rdp.sh ${{ github.event.inputs.date }}

      - name: Check if git branch aready exists
        shell: bash
        run: |
          existed_in_remote=$(git ls-remote --heads origin rdp/${{ github.event.inputs.date }})

          if [[ -z ${existed_in_remote} ]]; then
              echo "::notice::La branche de la prochaine RDP n'existe pas encore et sera crÃ©Ã©e."
              echo 0
          else
              echo "::error::La branche existe dÃ©jÃ . Le risque d'Ã©crasement est trop important !"
              exit 1
          fi

      - name: New branch
        run: |
          git config user.name ${{ github.actor }}
          git config user.email '${{ github.actor }}@users.noreply.github.com'
          git checkout -b rdp/${{ github.event.inputs.date }}
          git status

      - name: Commit new GeoRDP
        run: |
          git add content/rdp/
          git commit -am "ðŸ—ž CrÃ©e la GeoRDP du ${{ github.event.inputs.date }}"

      - name: Push to remote
        run: git push origin rdp/${{ github.event.inputs.date }}

      - name: Create Pull Request
        id: cpr
        uses: repo-sync/pull-request@v2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          source_branch: rdp/${{ github.event.inputs.date }}
          destination_branch: "main"
          pr_allow_empty: false
          pr_title: "GeoRDP du ${{ github.event.inputs.date }}"
          pr_template: .github/PULL_REQUEST_TEMPLATE.md

      - name: Notify Slack
        run: |
          echo "Notification sur Slack : Pull Request URL - ${{ steps.cpr.outputs.pr_url }}"

      - name: Slack Notification Demo
        uses: bryannice/gitactions-slack-notification@2
        env:
          SLACK_INCOMING_WEBHOOK: ${{ secrets.SLACK_INCOMING_WEBHOOK }}
          SLACK_MESSAGE: |
            C'est reparti pour une nouvelle RDP :

              - la PR : ${{ steps.cpr.outputs.pr_url }}
              - la preview : https://preview-pullrequest-${{steps.open-pr.outputs.pr_number}}--geotribu-preprod.netlify.app/
          SLACK_TITLE: ':newspaper_roll: GeoRDP du ${{ github.event.inputs.date }}'

      #  AUTRE METHODE MAIS QUI NE PERMET PAS D'UTILISER LE TEMPLATE

      # - name: Load PR template as variable
      #   id: pr-template-var
      #   shell: bash
      #   run: |
      #     echo "::set-output name=pr-body::$(<.github/PULL_REQUEST_TEMPLATE.md)"

      # - name: Create Pull Request
      #   id: cpr
      #   uses: peter-evans/create-pull-request@v3
      #   with:
      #     branch: rdp/${{ github.event.inputs.date }}
      #     commit-message: "GeoRDP du ${{ github.event.inputs.date }}"
      #     committer: ${{ github.actor }} <${{ github.actor }}@users.noreply.github.com>
      #     delete-branch: true
      #     # draft: true
      #     title: "GeoRDP du ${{ github.event.inputs.date }}"
      #     body: "${{ steps.pr-template-var.outputs.pr-body }}"

      # - name: Notify Slack
      #   run: |
      #     echo "Notification sur Slack : Pull Request URL - ${{ steps.cpr.outputs.pull-request-url }}"
