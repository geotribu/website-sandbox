name: "üóû New GeoRDP"

on:
  workflow_dispatch:
    inputs:
      date:
        type: string
        description: Date de la prochaine RDP au format YYYY-MM-DD
        required: true
      notify-slack:
        type: boolean
        description: Notifie l'√©quipe sur Slack

env:
  LANG: "fr_FR.UTF-8"
  LC_ALL: "fr_FR.UTF-8"
  LC_TIME: "fr_FR.UTF-8"

jobs:
  create_rdp:
    runs-on: ubuntu-latest

    steps:
      - name: Install French locale
        run: |
          sudo locale-gen fr_FR.UTF-8
          sudo update-locale LANG=fr_FR.UTF-8

      - name: Get source code
        uses: actions/checkout@v2

      - name: Create a new GeoRDP
        shell: bash
        run: |
          # make file runnable, might not be necessary
          # chmod +x ./tools/new_rdp.sh

          # run script
          bash ./tools/new_rdp.sh ${{ github.event.inputs.date }}

      - name: Check if git branch aready exists
        shell: bash
        run: |
          existed_in_remote=$(git ls-remote --heads origin rdp/${{ github.event.inputs.date }})

          if [[ -z ${existed_in_remote} ]]; then
              echo "::notice::La branche de la prochaine RDP n'existe pas encore et sera cr√©√©e."
              echo 0
          else
              echo "::error::La branche existe d√©j√†. Le risque d'√©crasement est trop important !"
              exit 1
          fi

      - name: New branch
        run: |
          git config user.name ${{ github.actor }}
          git config user.email '${{ github.actor }}@users.noreply.github.com'
          git checkout -b rdp/${{ github.event.inputs.date }}
          git status

      - name: Commit new GeoRDP
        run: |
          git add content/rdp/
          git commit -am "üóû Cr√©e la GeoRDP du ${{ github.event.inputs.date }}"

      - name: Push to remote
        run: git push origin rdp/${{ github.event.inputs.date }}

      - name: Create Pull Request
        id: cpr
        uses: repo-sync/pull-request@v2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          source_branch: rdp/${{ github.event.inputs.date }}
          destination_branch: "main"
          pr_allow_empty: false
          pr_title: "GeoRDP du ${{ github.event.inputs.date }}"
          pr_template: .github/PULL_REQUEST_TEMPLATE.md

      - name: Notification Slack
        id: slack
        uses: slackapi/slack-github-action@v1.16
        if: ${{ ${{ github.event.inputs.notify-slack }} == 'true'
        with:
          payload: '{"blocks":[{"type":"section","text":{"type":"mrkdwn","text":":newspaper: La GeoRDP du ${{ github.event.inputs.date }} a √©t√© cr√©√©e et attend vos contributions :writing_hand: !"}},{"type":"section","fields":[{"type":"mrkdwn","text":"Cr√©√©e par *${{ github.actor }}* via GitHub Action."}]},{"type":"actions","elements":[{"type":"button","text":{"type":"plain_text","emoji":true,"text":":squid: Voir la PR (GitHub)"},"url":"${{ steps.cpr.outputs.pr_url }}"},{"type":"button","text":{"type":"plain_text","emoji":true,"text":":eye: Voir la preview (Netlify)"},"style":"primary","url":"https://preview-pullrequest-${{steps.cpr.outputs.pr_number}}--geotribu-preprod.netlify.app/"}]}]}'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

      #  AUTRE METHODE MAIS QUI NE PERMET PAS D'UTILISER LE TEMPLATE

      # - name: Load PR template as variable
      #   id: pr-template-var
      #   shell: bash
      #   run: |
      #     echo "::set-output name=pr-body::$(<.github/PULL_REQUEST_TEMPLATE.md)"

      # - name: Create Pull Request
      #   id: cpr
      #   uses: peter-evans/create-pull-request@v3
      #   with:
      #     branch: rdp/${{ github.event.inputs.date }}
      #     commit-message: "GeoRDP du ${{ github.event.inputs.date }}"
      #     committer: ${{ github.actor }} <${{ github.actor }}@users.noreply.github.com>
      #     delete-branch: true
      #     # draft: true
      #     title: "GeoRDP du ${{ github.event.inputs.date }}"
      #     body: "${{ steps.pr-template-var.outputs.pr-body }}"

      # - name: Notify Slack
      #   run: |
      #     echo "Notification sur Slack : Pull Request URL - ${{ steps.cpr.outputs.pull-request-url }}"
